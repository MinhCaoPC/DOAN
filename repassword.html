<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quên Mật Khẩu</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="repassword.css">
  </head>
<body>

<div class="reset-container">
  
  <div id="msg" class="mb-2 fw-bold"></div>

  <div id="step1" class="step-section active">
    <h3>Quên Mật Khẩu?</h3>
    <p class="desc">Đừng lo! Nhập email của bạn để nhận mã xác nhận.</p>
    <form id="formEmail">
      <div class="mb-3 text-start">
        <label class="form-label fw-bold small text-muted">Email đăng ký</label>
        <div class="input-group">
          <span class="input-group-text bg-white border-end-0"><i class="bi bi-envelope"></i></span>
          <input type="email" id="email" class="form-control border-start-0 ps-0" placeholder="name@example.com" required>
        </div>
      </div>
      <button class="btn-reset" type="submit">Gửi mã xác nhận</button>
    </form>
    <a href="dangNhap.html" class="back-link"><i class="bi bi-arrow-left"></i> Quay lại đăng nhập</a>
  </div>

  <div id="step2" class="step-section">
    <h3>Xác Thực Mã</h3>
    <p class="desc">Mã 6 số đã được gửi tới email của bạn.</p>
    
    <form id="formCode">
      <div class="mb-3">
        <input type="text" id="otpCode" class="form-control otp-input" placeholder="000000" maxlength="6" required autocomplete="off">
      </div>
      <button class="btn-reset" type="submit">Tiếp tục</button>
    </form>

    <div class="d-flex justify-content-between align-items-center mt-3">
      <div id="timer" class="text-danger fw-bold"></div>
      <button id="btnResend" class="btn btn-sm btn-outline-secondary border-0" type="button">Gửi lại mã</button>
    </div>
    
    <div class="mt-3">
      <a href="#" onclick="window.location.reload()" class="small text-muted">Đổi email khác?</a>
    </div>
  </div>

  <div id="step3" class="step-section">
    <h3>Mật Khẩu Mới</h3>
    <p class="desc">Hãy nhập mật khẩu mạnh để bảo vệ tài khoản.</p>
    
    <form id="formNewPass">
      <div class="password-field">
        <input type="password" id="newPass" class="form-control" placeholder="Mật khẩu mới" required>
        <i class="bi bi-eye-slash eye" onclick="togglePass('newPass', this)"></i>
      </div>
      
      <div class="password-field">
        <input type="password" id="confirmPass" class="form-control" placeholder="Nhập lại mật khẩu" required>
        <i class="bi bi-eye-slash eye" onclick="togglePass('confirmPass', this)"></i>
      </div>

      <button class="btn-reset" type="submit">Đổi mật khẩu</button>
    </form>
  </div>

</div>

<script>
  // === CẤU HÌNH DOM ===
  const msgDiv = document.getElementById('msg');
  const step1 = document.getElementById('step1');
  const step2 = document.getElementById('step2');
  const step3 = document.getElementById('step3');
  const timerEl = document.getElementById('timer');
  const btnResend = document.getElementById('btnResend');

  // Biến lưu tạm dữ liệu
  let savedEmail = '';
  let savedCode = '';
  let countdownId;

  // Hàm hiển thị thông báo
  function showMsg(text, type = 'danger') {
    msgDiv.textContent = text;
    msgDiv.className = `mb-3 fw-bold text-${type}`;
    // Tự ẩn sau 3s
    setTimeout(() => { msgDiv.textContent = ''; }, 5000);
  }

  // Hàm chuyển Step
  function switchStep(from, to) {
    from.classList.remove('active');
    setTimeout(() => {
      to.classList.add('active');
    }, 200); // Delay nhẹ cho animation mượt
  }

  // Hàm Toggle Ẩn/Hiện mật khẩu
  function togglePass(inputId, icon) {
    const input = document.getElementById(inputId);
    const type = input.getAttribute("type") === "password" ? "text" : "password";
    input.setAttribute("type", type);
    icon.classList.toggle("bi-eye");
    icon.classList.toggle("bi-eye-slash");
  }

  // Hàm đếm ngược
  function startCountdown(seconds = 600) {
    clearInterval(countdownId);
    const end = Date.now() + seconds * 1000;
    btnResend.disabled = true; // Khóa nút gửi lại

    countdownId = setInterval(() => {
      const left = Math.max(0, Math.floor((end - Date.now()) / 1000));
      const m = String(Math.floor(left / 60)).padStart(2, '0');
      const s = String(left % 60).padStart(2, '0');
      
      timerEl.textContent = `${m}:${s}`;

      if (left <= 0) {
        clearInterval(countdownId);
        timerEl.textContent = 'Hết hạn';
        btnResend.disabled = false; // Mở lại nút gửi lại
        btnResend.textContent = "Gửi lại mã";
      }
    }, 1000);
  }

  // === LOGIC STEP 1: GỬI MÃ ===
  document.getElementById('formEmail').addEventListener('submit', async (e) => {
    e.preventDefault();
    const emailInput = document.getElementById('email').value.trim();
    if (!emailInput) return showMsg('Vui lòng nhập email!');

    const btn = e.target.querySelector('button');
    const originalText = btn.textContent;
    btn.disabled = true; btn.textContent = 'Đang xử lý...';

    try {
      const res = await fetch('/api/send.php', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email: emailInput })
      });
      const data = await res.json();

      if (data.status === 'success') {
        savedEmail = emailInput; // Lưu email để dùng sau
        switchStep(step1, step2);
        startCountdown(600);
        showMsg(data.message, 'success');
      } else {
        showMsg(data.message || 'Lỗi gửi mail', 'danger');
      }
    } catch (err) {
      console.error(err);
      showMsg('Lỗi kết nối server!', 'danger');
    } finally {
      btn.disabled = false; btn.textContent = originalText;
    }
  });

  // === LOGIC STEP 2: NHẬP CODE (CHỈ KIỂM TRA ĐỘ DÀI RỒI CHUYỂN STEP) ===
  // Lưu ý: Backend của bạn check code và đổi pass cùng lúc, nên ở bước này ta chỉ
  // kiểm tra định dạng visual, chưa gửi lên server ngay.
  document.getElementById('formCode').addEventListener('submit', (e) => {
    e.preventDefault();
    const codeInput = document.getElementById('otpCode').value.trim();

    if (!/^\d{6}$/.test(codeInput)) {
      return showMsg('Mã xác nhận phải gồm 6 chữ số!', 'danger');
    }

    // Nếu đúng định dạng -> Lưu code -> Chuyển sang nhập pass
    savedCode = codeInput;
    switchStep(step2, step3);
    showMsg('Mã hợp lệ. Vui lòng tạo mật khẩu mới.', 'primary');
  });

  // === LOGIC STEP 3: ĐỔI MẬT KHẨU (GỬI ALL LÊN SERVER) ===
  document.getElementById('formNewPass').addEventListener('submit', async (e) => {
    e.preventDefault();
    const newPass = document.getElementById('newPass').value.trim();
    const confirmPass = document.getElementById('confirmPass').value.trim();

    if (newPass.length < 8) return showMsg('Mật khẩu tối thiểu 8 ký tự!', 'danger');
    if (newPass !== confirmPass) return showMsg('Hai mật khẩu không khớp!', 'danger');

    const btn = e.target.querySelector('button');
    btn.disabled = true; btn.textContent = 'Đang cập nhật...';

    try {
      // Gửi cả Email, Code, NewPass lên endpoint check_send.php
      const res = await fetch('/api/check_send.php', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
          email: savedEmail, 
          code: savedCode, 
          newPass: newPass 
        })
      });
      
      const data = await res.json();

      if (data.status === 'success') {
        showMsg('Đổi mật khẩu thành công! Đang chuyển hướng...', 'success');
        setTimeout(() => location.href = 'dangNhap.html', 2000);
      } else {
        // Nếu server báo lỗi (ví dụ sai mã code), có thể phải quay lại bước 2
        showMsg(data.message || 'Mã xác nhận không đúng hoặc hết hạn!', 'danger');
        btn.disabled = false; btn.textContent = 'Thử lại';
        
        // Tùy chọn: Nếu sai mã thì quay lại bước 2
        if(data.message && data.message.includes('code')) {
             setTimeout(() => switchStep(step3, step2), 1500);
        }
      }
    } catch (err) {
      console.error(err);
      showMsg('Lỗi kết nối server!', 'danger');
      btn.disabled = false; btn.textContent = 'Đổi mật khẩu';
    }
  });

  // === NÚT GỬI LẠI MÃ (Ở STEP 2) ===
  btnResend.addEventListener('click', async () => {
    if (!savedEmail) return;
    btnResend.disabled = true; btnResend.textContent = 'Đang gửi...';

    try {
      const res = await fetch('/api/send.php', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email: savedEmail })
      });
      const data = await res.json();
      if (data.status === 'success') {
        showMsg('Đã gửi lại mã mới!', 'success');
        startCountdown(600);
      } else {
        showMsg(data.message, 'danger');
        btnResend.disabled = false; btnResend.textContent = 'Gửi lại mã';
      }
    } catch (err) {
      showMsg('Lỗi kết nối!', 'danger');
      btnResend.disabled = false; btnResend.textContent = 'Gửi lại mã';
    }
  });

  

</script>

</body>
</html>