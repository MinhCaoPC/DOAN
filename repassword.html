<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quên Mật Khẩu - Đà Nẵng Travel</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body{min-height:100vh;display:flex;justify-content:center;align-items:center;font-family:Arial,sans-serif;background:linear-gradient(135deg,#6dd5ed,#2193b0);position:relative;overflow:hidden}
  body::before{content:"";position:absolute;inset:0;background:url('images/banner-DN.png') center/cover no-repeat;filter:brightness(.6);z-index:-1}
  .reset-box{background:rgba(255,255,255,.95);padding:40px 30px;border-radius:20px;box-shadow:0 8px 25px rgba(0,0,0,.2);width:100%;max-width:400px;text-align:center}
  .btn-reset{background:#2193b0;color:#fff;border:none;width:100%;padding:12px;border-radius:10px;font-weight:600}
  .btn-reset:hover{background:#176a8a}
</style>
</head>
<body>
<div class="reset-box">
  <h2>Quên Mật Khẩu</h2>


  <!-- Bước 1: Nhập email -->
  <div id="step1">
    <p>Nhập email để nhận mã xác nhận:</p>
    <form id="formEmail">
      <input type="email" id="email" class="form-control mb-3" placeholder="Nhập email của bạn" required>
      <button class="btn-reset" type="submit">Gửi mã xác nhận</button>
    </form>
  </div>


  <!-- Bước 2: Nhập mã + mật khẩu mới -->
  <div id="step2" style="display:none">
    <p>Nhập mã xác nhận & mật khẩu mới:</p>
    <form id="formVerify">
      <input type="text" id="code" class="form-control mb-3" placeholder="Mã xác nhận (6 số)" maxlength="6" required>
      <input type="password" id="newPass" class="form-control mb-3" placeholder="Mật khẩu mới" required>
      <button class="btn-reset" type="submit">Đặt lại mật khẩu</button>
    </form>
    <button id="btnResend" class="btn btn-link mt-2" type="button">Gửi lại mã?</button>
    <div id="timer" class="text-muted"></div>
  </div>


  <a href="dangNhap.html" class="d-block mt-3" style="color:#2193b0">Quay về đăng nhập</a>
  <p id="msg" class="mt-3 fw-semibold"></p>
</div>


<script>
const msg   = document.getElementById('msg');
const step1 = document.getElementById('step1');
const step2 = document.getElementById('step2');
const timer = document.getElementById('timer');
const btnResend = document.getElementById('btnResend');
let countdownId;


function showMsg(text, ok){ msg.textContent=text; msg.style.color= ok? 'green':'red'; }


function startCountdown(seconds=600){
  clearInterval(countdownId);
  const end = Date.now()+seconds*1000;
  countdownId = setInterval(()=>{
    const left = Math.max(0, Math.floor((end-Date.now())/1000));
    const m = String(Math.floor(left/60)).padStart(2,'0');
    const s = String(left%60).padStart(2,'0');
    timer.textContent = `Mã hết hạn sau ${m}:${s}`;
    if(left<=0){ clearInterval(countdownId); timer.textContent='Mã đã hết hạn. Nhấn "Gửi lại mã?" để nhận mã mới.'; }
  }, 500);
}



// Bước 1: Gửi mã
document.getElementById('formEmail').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const email = document.getElementById('email').value.trim();
  if (!email) { showMsg('Vui lòng nhập email!', false); return; }


  const btn = e.target.querySelector('button');
  btn.disabled = true; btn.textContent = 'Đang gửi...';
  showMsg('Đang gửi mã xác nhận...', false);


  try {
    const res = await fetch('/api/send.php', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({email})
    });
    const data = await res.json();
    showMsg(data.message, data.status==='success');
    if(data.status==='success'){
      sessionStorage.setItem('resetEmail', email);
      step1.style.display='none'; step2.style.display='block';
      startCountdown(600);
    }
  } catch(err){
    showMsg('Không kết nối được máy chủ!', false);
  } finally {
    btn.disabled = false; btn.textContent = 'Gửi mã xác nhận';
  }
});


//Bước 2: Xác minh mã & đặt lại mật khẩu
document.getElementById('formVerify').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const email = sessionStorage.getItem('resetEmail');
  if (!email) { showMsg('Thiếu email. Vui lòng quay lại bước 1.', false); return; }


  const code = document.getElementById('code').value.trim();
  const newPass = document.getElementById('newPass').value.trim();


  if (!/^\d{6}$/.test(code)) { showMsg('Mã xác nhận phải gồm 6 chữ số.', false); return; }
  if (newPass.length < 6) { showMsg('Mật khẩu mới tối thiểu 6 ký tự.', false); return; }


  const btn = e.target.querySelector('button');
  btn.disabled = true; btn.textContent = 'Đang xử lý...';
  showMsg('Đang xác minh...', false);


  try {
    const res = await fetch('/api/check_send.php', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({email,code,newPass})
    });


    let data;
    try {
      data = await res.json();
    } catch(parseErr) {
      showMsg('Máy chủ trả về dữ liệu không hợp lệ.', false);
      return;
    }


    showMsg(data.message, data.status==='success');
    if(data.status==='success'){
      setTimeout(()=>location.href='dangNhap.html', 1500);
    }
  } catch(err){
    showMsg('Không kết nối được máy chủ!', false);
  } finally {
    btn.disabled = false; btn.textContent = 'Đặt lại mật khẩu';
  }
});







// Gửi lại mã 
btnResend.addEventListener('click', async ()=>{
  const email = sessionStorage.getItem('resetEmail');
  if(!email){ showMsg('Thiếu email. Vui lòng quay lại bước 1.', false); return; }


  btnResend.disabled = true; btnResend.textContent = 'Đang gửi lại...';
  showMsg('Đang gửi lại mã...', false);


  try {
    const res = await fetch('/api/send.php', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({email})
    });
    const data = await res.json();
    showMsg(data.message, data.status==='success');
    if(data.status==='success'){ startCountdown(600); }
  } catch(err) {
    showMsg('Không kết nối được máy chủ!', false);
  } finally {
    btnResend.disabled = false; btnResend.textContent = 'Gửi lại mã?';
  }
});
</script>



</body>
</html>
