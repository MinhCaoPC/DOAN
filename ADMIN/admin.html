<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Web Du Lịch Đà Nẵng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="admin.css">

</head>

<body>

    <div class="sidebar">
        <h4><i class="fas fa-plane-departure"></i> Admin Đà Nẵng</h4>

        <a href="#" onclick="showSection('dashboard', event)" class="nav-link active">
            <i class="fas fa-tachometer-alt"></i> Tổng quan
        </a>
        <a href="#" onclick="showSection('users', event)" class="nav-link">
            <i class="fas fa-users"></i> Quản lý Tài khoản KH
        </a>
        <a href="#" onclick="showSection('tours', event)" class="nav-link">
            <i class="fas fa-map-marked-alt"></i> Quản lý Tour
        </a>
        <a href="#" onclick="showSection('locations', event)" class="nav-link">
            <i class="fas fa-landmark"></i> Địa danh
        </a>
        <a href="#" onclick="showSection('resort', event)" class="nav-link">
            <i class="fas fa-landmark"></i> Nghỉ dưỡng
        </a>
        <a href="#" onclick="showSection('food', event)" class="nav-link">
            <i class="fas fa-utensils"></i> Ẩm thực
        </a>
        <a href="#" onclick="showSection('booking', event)" class="nav-link">
            <i class="fas fa-history"></i> Lịch sử Đặt Tour
        </a>
        <a href="#" onclick="showSection('contacts', event)" class="nav-link">
            <i class="fas fa-envelope"></i> Liên hệ cần tư vấn
        </a>
    </div>

    <div class="main-content">

        <div class="top-navbar rounded">
            <h5>Xin chào, <strong>QuanTriVien</strong></h5>
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle" type="button" id="dropdownMenuButton1"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-user-cog"></i> Cài đặt
                </button>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                    <li><a class="dropdown-item" href="#"><i class="fas fa-key"></i> Đặt lại mật khẩu</a></li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li><a class="dropdown-item text-danger" href="#"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>
                    </li>
                </ul>
            </div>
        </div>

        <div id="dashboard" class="section-content active">
            <h3>Tổng quan hệ thống</h3>
            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="card card-box bg-gradient-primary p-3">
                        <h3>150</h3>
                        <p>Tour hiện có</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-box bg-gradient-success p-3">
                        <h3>1,200</h3>
                        <p>Khách hàng</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-box bg-gradient-warning p-3">
                        <h3>45</h3>
                        <p>Yêu cầu tư vấn mới</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-box bg-gradient-info p-3">
                        <h3>300</h3>
                        <p>Địa danh & Món ăn</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="users" class="section-content">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Quản lý Tài khoản Khách hàng</h3>
                <button class="btn btn-primary"><i class="fas fa-plus"></i> Thêm tài khoản</button>
            </div>
            <div class="card card-box p-3">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tên đăng nhập</th>
                            <th>Email</th>
                            <th>Họ và Tên</th>
                            <th>SĐT</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="tours" class="section-content">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Danh sách Tour Du Lịch</h3>
                <button class="btn btn-success"><i class="fas fa-plus"></i> Cập nhật Tour mới</button>
            </div>
            <div class="card card-box p-3">
                <p>Danh sách các tour Đà Nẵng - Hội An - Bà Nà...</p>
                <div class="alert alert-info">Chức năng cập nhật thông tin Tour, giá vé, lịch trình...</div>
            </div>
        </div>

        <div id="booking" class="section-content">
            <h3>Quản lý Lịch sử Đặt Tour</h3>
            <div class="card card-box p-3 mt-3">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Mã Đơn</th>
                            <th>Khách hàng</th>
                            <th>Tour</th>
                            <th>Ngày đi</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="contacts" class="section-content">
            <h3>Thông tin liên hệ cần tư vấn</h3>
            <div class="list-group mt-3" id="contact-list">
            </div>
        </div>

        <div id="locations" class="section-content">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Quản lý Địa danh</h3>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLocationModal"><i
                        class="fas fa-plus"></i> Thêm Địa danh mới</button>
            </div>

            <div class="card card-box p-3">
                <h4>Danh sách Địa danh</h4>
                <p>Danh sách các Địa danh sẽ được hiển thị ở đây.</p>
            </div>

            <div class="modal fade" id="addLocationModal" tabindex="-1" aria-labelledby="addLocationModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addLocationModalLabel">Thêm Địa danh mới</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form id="addLocationForm" onsubmit="event.preventDefault(); addLocation();"
                            enctype="multipart/form-data">
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="tenDD" class="form-label">Tên Địa danh (*)</label>
                                        <input type="text" class="form-control" id="tenDD" name="tenDD" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="loaiDD" class="form-label">Loại Địa danh (*)</label>
                                        <select class="form-control" id="loaiDD" name="loaiDD" required>
                                            <option value="">-- Chọn Loại Địa danh --</option>
                                            <option value="thiennhien">Thiên nhiên</option>
                                            <option value="congtrinh">Công trình</option>
                                            <option value="vanhoa">Văn hóa</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="diaChiDD" class="form-label">Địa chỉ</label>
                                    <input type="text" class="form-control" id="diaChiDD" name="diaChiDD">
                                </div>
                                <div class="mb-3">
                                    <label for="mapLinkDD" class="form-label">Link Google Map</label>
                                    <input type="url" class="form-control" id="mapLinkDD" name="mapLinkDD">
                                </div>
                                <div class="mb-3">
                                    <label for="moTaDD" class="form-label">Mô tả chi tiết</label>
                                    <textarea class="form-control" id="moTaDD" name="moTaDD" rows="4"
                                        required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="imageDD" class="form-label">Ảnh Địa danh (*)</label>
                                    <input class="form-control" type="file" id="imageDD" name="imageDD" accept="image/*"
                                        required>
                                    <div class="form-text">Chọn ảnh định dạng JPG, PNG, GIF.</div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                <button type="submit" class="btn btn-primary" id="submitLocationBtn">Lưu Địa
                                    danh</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="food" class="section-content">
            <h3>Cập nhật Món ăn</h3>
            <p>Form nhập liệu cho ẩm thực địa phương...</p>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        
        async function loadDashboardData() {
            try {
                const response = await fetch('dashboard.php');
                const result = await response.json();

                if (result.status === 'success') {
                    const data = result.data;
                    document.querySelector('#dashboard .bg-gradient-primary h3').textContent = data.total_tours;
                    document.querySelector('#dashboard .bg-gradient-success h3').textContent = data.total_customers;
                    document.querySelector('#dashboard .bg-gradient-warning h3').textContent = data.new_contacts;
                    document.querySelector('#dashboard .bg-gradient-info h3').textContent = data.total_locations;
                } else {
                    console.error("Lỗi Dashboard:", result.message);
                }
            } catch (error) {
                console.error('Lỗi kết nối Dashboard:', error);
            }
        }

        async function loadUsersData() {
            const tableBody = document.querySelector('#users table tbody');

            try {
                const response = await fetch('admin.php?action=read');
                const result = await response.json();

                tableBody.innerHTML = '';

                if (result.status === 'success') {
                    result.data.forEach(user => {
                        const row = `
                        <tr>
                            <td>${user.MaSoTK}</td>
                            <td>${user.TenTaiKhoan}</td>
                            <td>${user.Email}</td>
                            <td>${user.HoVaTen || 'N/A'}</td>
                            <td>${user.SDT || 'N/A'}</td>
                            <td>
                                <button class="btn btn-sm btn-warning"><i class="fas fa-edit"></i> Sửa</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.MaSoTK}')"><i class="fas fa-trash"></i> Xoá</button>
                            </td>
                        </tr>
                    `;
                        tableBody.insertAdjacentHTML('beforeend', row);
                    });
                } else {
                    tableBody.innerHTML = `<tr><td colspan="6">Lỗi tải dữ liệu: ${result.message}</td></tr>`;
                }
            } catch (error) {
                console.error('Lỗi kết nối Users:', error);
                tableBody.innerHTML = `<tr><td colspan="6">Lỗi kết nối server.</td></tr>`;
            }
        }

        async function loadContactsData() {
            try {
                const response = await fetch('nhanlienhe.php');
                const result = await response.json();
                const contactList = document.getElementById('contact-list');
                contactList.innerHTML = '';

                if (result.status === 'success' && result.data.length > 0) {
                    result.data.forEach(contact => {
                        const time = new Date(contact.ThoiGianTao).toLocaleString('vi-VN');
                        const row = `
                        <a href="#" class="list-group-item list-group-item-action flex-column align-items-start">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">${contact.HoVaTenTuVan} - Chủ đề: ${contact.ChuDeQuanTam}</h5>
                                <small>${time}</small>
                            </div>
                            <p class="mb-1">Email: ${contact.EmailTuVan} | SĐT: ${contact.SoDienThoaiTuVan}</p>
                            <small>Nội dung: ${contact.NoiDung.substring(0, 100)}...</small>
                        </a>
                    `;
                        contactList.insertAdjacentHTML('beforeend', row);
                    });
                } else {
                    contactList.innerHTML = `<div class="alert alert-warning">Không có yêu cầu tư vấn mới.</div>`;
                }
            } catch (error) {
                console.error('Lỗi kết nối Contacts:', error);
                document.getElementById('contact-list').innerHTML = `<div class="alert alert-danger">Lỗi kết nối server.</div>`;
            }
        }

        async function deleteUser(maSoTK) {
            if (!confirm(`Bạn có chắc chắn muốn xóa tài khoản ${maSoTK} không?`)) return;

            try {
                const formData = new FormData();
                formData.append('MaSoTK', maSoTK);

                const response = await fetch('admin.php?action=delete', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.status === 'success') {
                    alert(result.message);
                    loadUsersData();
                } else {
                    alert('Lỗi: ' + result.message);
                }

            } catch (error) {
                alert('Lỗi kết nối server: ' + error);
            }
        }

        async function addLocation() {
            const form = document.getElementById('addLocationForm');
            const submitBtn = document.getElementById('submitLocationBtn');
            const formData = new FormData(form);

            submitBtn.disabled = true;
            submitBtn.textContent = 'Đang xử lý...';

            try {
                const response = await fetch('add_diadanh.php?action=add', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.status === 'success') {
                    alert(result.message);
                    form.reset();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addLocationModal'));
                    if (modal) {
                        modal.hide();
                    }
                    loadLocationsData();
                } else {
                    alert('Lỗi: ' + result.message);
                }

            } catch (error) {
                console.error('Lỗi kết nối server:', error);
                alert('Lỗi kết nối server khi thêm Địa danh.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Lưu Địa danh';
            }
        }

        async function loadLocationsData() {
            const cardBox = document.querySelector('#locations .card-box');
            cardBox.innerHTML = `
        <h4>Danh sách Địa danh</h4>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Đường dẫn Ảnh</th> <th>Tên Địa danh</th>
                        <th>Loại</th>
                        <th>Địa chỉ</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    `;
            const tableBody = cardBox.querySelector('tbody');

            try {
                const response = await fetch('add_diadanh.php?action=read');
                const result = await response.json();

                tableBody.innerHTML = '';

                if (result.status === 'success') {
                    result.data.forEach(location => {
                        // ĐÃ SỬA: Chỉ hiển thị đường dẫn ImageDD từ CSDL
                        const imagePathDisplay = location.ImageDD; 
                        const row = `
                    <tr>
                        <td>${location.MaDD}</td>
                        <td>${imagePathDisplay}</td> <td>${location.TenDD}</td>
                        <td>${location.LoaiDD || 'N/A'}</td>
                        <td>${location.DiaChiDD || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-warning"><i class="fas fa-edit"></i> Sửa</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteLocation('${location.MaDD}', '${location.ImageDD}')"><i class="fas fa-trash"></i> Xoá</button>
                        </td>
                    </tr>
                `;
                        tableBody.insertAdjacentHTML('beforeend', row);
                    });
                } else {
                    tableBody.innerHTML = `<tr><td colspan="6">Lỗi tải dữ liệu: ${result.message}</td></tr>`;
                }
            } catch (error) {
                console.error('Lỗi kết nối Locations:', error);
                tableBody.innerHTML = `<tr><td colspan="6">Lỗi kết nối server.</td></tr>`;
            }
        }

        async function deleteLocation(maDD, imagePath) {
            if (!confirm(`Bạn có chắc chắn muốn xóa Địa danh ID ${maDD} không?`)) return;

            try {
                const formData = new FormData();
                formData.append('MaDD', maDD);
                formData.append('ImagePath', imagePath);

                const response = await fetch('add_diadanh.php?action=delete', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.status === 'success') {
                    alert(result.message);
                    loadLocationsData();
                } else {
                    alert('Lỗi: ' + result.message);
                }

            } catch (error) {
                alert('Lỗi kết nối server: ' + error);
            }
        }

        function showSection(sectionId, event) {
            if (event) {
                event.preventDefault();
            }

            const sections = document.querySelectorAll('.section-content');
            sections.forEach(sec => sec.classList.remove('active'));

            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            navLinks.forEach(link => link.classList.remove('active'));

            document.getElementById(sectionId).classList.add('active');

            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }

            if (sectionId === 'dashboard') {
                loadDashboardData();
            } else if (sectionId === 'users') {
                loadUsersData();
            } else if (sectionId === 'contacts') {
                loadContactsData();
            } else if (sectionId === 'locations') {
                loadLocationsData();
            }
        }

        window.onload = loadDashboardData; 
    </script>
</body>

</html>