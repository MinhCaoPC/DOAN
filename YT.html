<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Danh sÃ¡ch yÃªu thÃ­ch</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <!-- CSS riÃªng -->
  <link rel="stylesheet" href="YT.css">
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-custom fixed-top" id="navbar">
    <div class="container">
      <!-- Logo -->
      <a class="navbar-logo-fixed" href="#">
        <img src="images/logo.png" alt="Logo" class="logo-fixed" />
      </a>

      <!-- Toggler -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Menu -->
      <div class="collapse navbar-collapse justify-content-center" id="navbarMenu">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="TrangChu.html">TRANG CHá»¦</a></li>
          <li class="nav-item">
            <a class="nav-link" href="diaDanh.html">Äá»ŠA DANH Ná»”I Báº¬T</a>
          </li>
          <li class="nav-item"><a class="nav-link" href="Food.html">áº¨M THá»°C</a></li>
          <li class="nav-item">
            <a class="nav-link" href="nghiDuong.html">NGHá»ˆ DÆ¯á» NG</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="tour.html">TOUR</a>
          </li>
        </ul>


        <div class="login-section" id="login-section">
          <a href="dangNhap.html" class="login-text">
            <i class="bi bi-person-circle me-2 fs-5"></i>ÄÄ‚NG NHáº¬P
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- banner -->
  <div class="favorite-banner">
    <div class="favorite-banner__content">
      <h1>Danh SÃ¡ch yÃªu thÃ­ch</h1>
    </div>
  </div>

  <div class="banner-divider"></div>


  <div class="favorites-section">
    <!-- Cá»™t trÃ¡i: danh sÃ¡ch phÃ¢n loáº¡i -->
    <aside class="favorites-sidebar">
  <h2>PhÃ¢n loáº¡i</h2>
  <ul id="filter-list">
    <li data-filter="ALL" class="active">Táº¥t cáº£</li>
    <li data-filter="DIADANH">Äá»‹a danh</li>
    <li data-filter="MONAN">áº¨m thá»±c</li>
    <li data-filter="KND">Nghá»‰ dÆ°á»¡ng - vui chÆ¡i</li>
    <li data-filter="TOUR">Tour</li>
  </ul>
</aside>





    <!-- Cá»™t pháº£i: danh sÃ¡ch yÃªu thÃ­ch -->
    <div class="favorites-cards">

      </div>


    </div>
  </div>
  </div>

  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let isLoggedIn = false;
  let allFavorites = []; // lÆ°u toÃ n bá»™ items Ä‘á»ƒ filter

function getLinkForItem(item) {
  switch (item.loai) {
    case "DIADANH":
      return `diaDanh.html#item-dd-${item.id}`;
    case "MONAN":
      return `Food.html#item-monan-${item.id}`;
    case "KND":
      return `nghiDuong.html#item-knd-${item.id}`;
      
    case "TOUR":
      return `tour.html#item-tour-${item.id}`; 
      
    default:
      return null; 
  }
}


  // Render danh sÃ¡ch yÃªu thÃ­ch (theo list Ä‘Ã£ lá»c)
  function renderFavorites(items) {
    const container = document.querySelector(".favorites-cards");
    container.innerHTML = "";

    if (!items || items.length === 0) {
      container.innerHTML = `
        <div class="alert alert-info">
          Báº¡n chÆ°a cÃ³ má»¥c yÃªu thÃ­ch nÃ o. HÃ£y quay láº¡i cÃ¡c trang Äá»‹a danh / áº¨m thá»±c / Nghá»‰ dÆ°á»¡ng / Tour vÃ  báº¥m icon trÃ¡i tim ğŸ’– nhÃ©!
        </div>`;
      return;
    }

    items.forEach((item) => {
      const box = document.createElement("div");
      box.className = "content-box"; // Giá»¯ nguyÃªn "content-box" cá»§a báº¡n

      // â­ 2. (THAY Äá»”I) ThÃªm sá»± kiá»‡n onclick cho tháº» DIV
      const link = getLinkForItem(item);
      if (link) {
        // ThÃªm class 'clickable' Ä‘á»ƒ báº¡n cÃ³ thá»ƒ thÃªm CSS (vÃ­ dá»¥: Ä‘á»•i con trá» chuá»™t)
        box.classList.add("clickable-card"); 
        
        // ThÃªm sá»± kiá»‡n onclick Ä‘á»ƒ chuyá»ƒn trang
        box.onclick = function(event) {
          // Ráº¥t quan trá»ng: Chá»‰ Ä‘iá»u hÆ°á»›ng náº¿u click khÃ´ng pháº£i lÃ  vÃ o nÃºt "close"
          // (náº¿u khÃ´ng báº¥m nÃºt XÃ³a cÅ©ng sáº½ bá»‹ nháº£y trang)
          if (event.target.closest('.btn-close')) {
            return;
          }
          // Äiá»u hÆ°á»›ng Ä‘áº¿n link
          window.location.href = link;
        };
      }


      // label loáº¡i cho Ä‘áº¹p (Äá»‹a danh / áº¨m thá»±c / ...)
      let label = "";
      switch (item.loai) {
        case "DIADANH": label = "Äá»‹a danh"; break;
        case "MONAN": label = "áº¨m thá»±c"; break;
        case "KND": label = "Nghá»‰ dÆ°á»¡ng - vui chÆ¡i"; break;
        case "TOUR": label = "Tour"; break;
      }

      box.innerHTML = `
        <img src="${item.anh}" alt="${item.ten}">
        <div class="text-box">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h3 class="mb-0">${item.ten}</h3>
          </div>
          <p>${item.moTa || ""}</p>
          <span class="badge bg-primary">${label}</span>
          <div class="content-box-buttons">
            <button class="btn-circle btn-close" onclick="removeFavorite('${item.loai}', ${item.id}, event)">
              <i class="fa fa-times"></i>
            </button>
          </div>
        </div>
      `;

      container.appendChild(box);
    });
  }

  // Ãp dá»¥ng filter theo loáº¡i
  function applyFilter(type) {
    let filtered = allFavorites;

    if (type && type !== "ALL") {
      filtered = allFavorites.filter((item) => item.loai === type);
    }

    renderFavorites(filtered);
  }

  // XÃ³a khá»i yÃªu thÃ­ch
  // â­ 3. (THAY Äá»”I) ThÃªm 'event' vÃ  dÃ¹ng event.stopPropagation()
  async function removeFavorite(loai, id, event) {
    // NgÄƒn cháº·n sá»± kiá»‡n click lan ra (bubbling) tháº» div cha (trÃ¡nh bá»‹ nháº£y trang)
    if (event) {
        event.stopPropagation();
    }

    if (!confirm("Báº¡n cháº¯c cháº¯n muá»‘n xÃ³a má»¥c nÃ y khá»i danh sÃ¡ch yÃªu thÃ­ch?")) return;

    try {
      const res = await fetch("YT.php", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          action: "remove",
          loai: loai,
          id: id,
        }),
      });

      const data = await res.json();
      if (data.success) {
        alert("ÄÃ£ xÃ³a khá»i danh sÃ¡ch yÃªu thÃ­ch.");
        loadFavorites(); // Táº£i láº¡i danh sÃ¡ch
      } else {
        alert("âš ï¸ " + data.message);
      }
    } catch (err) {
      console.error(err);
      alert("CÃ³ lá»—i khi xÃ³a yÃªu thÃ­ch.");
    }
  }


async function loadFavorites() {
    try {
        const res = await fetch("YTList.php", { cache: "no-store" });
        if (!res.ok) {

            const errorBody = await res.json().catch(() => ({ 
                error: `HTTP Error: ${res.status} ${res.statusText}. KhÃ´ng thá»ƒ káº¿t ná»‘i CSDL.` 
            }));
            
            throw new Error(errorBody.error || `Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh tá»« server: ${res.status}`);
        }

        const data = await res.json();

        if (!data.loggedIn) {
            alert("Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ xem má»¥c yÃªu thÃ­ch.");
            window.location.href = "dangNhap.html";
            return;
        }

        isLoggedIn = true;
        allFavorites = data.items || [];
        const activeFilter = document.querySelector("#filter-list li.active")?.dataset.filter || "ALL";
        applyFilter(activeFilter);
        
    } catch (err) {
        console.error("Lá»—i khi táº£i má»¥c yÃªu thÃ­ch:", err.message);
        
        const container = document.querySelector(".favorites-cards");
        container.innerHTML = `
            <div class="alert alert-danger">
                KhÃ´ng táº£i Ä‘Æ°á»£c danh sÃ¡ch yÃªu thÃ­ch. <br>
                Chi tiáº¿t lá»—i: **${err.message}**
            </div>
        `;
    }
}

  document.addEventListener("DOMContentLoaded", () => {
    const loginSection = document.getElementById('login-section');
    const navbarMenu = document.getElementById('navbarMenu');

    // setup click filter (giá»¯ nguyÃªn)
    const filterList = document.getElementById("filter-list");
    if (filterList) {
      filterList.querySelectorAll("li").forEach((li) => {
        li.addEventListener("click", () => {
          filterList.querySelectorAll("li").forEach((x) => x.classList.remove("active"));
          li.classList.add("active");
          const type = li.dataset.filter || "ALL";
          applyFilter(type);
        });
      });
    }

    // check user + load favorites
    fetch('getUser.php')
      .then(res => res.json())
      .then(data => {
        if (data.loggedIn) {
          isLoggedIn = true;

          // Thay ná»™i dung login-section
          loginSection.innerHTML = `
            <a class="login-text" href="suaHS.html">
              <i class="bi bi-person-circle me-2 fs-5"></i>${data.TenTaiKhoan}
            </a>
            <a href="dangXuat.php" class="login-text ms-3">
              <i class="bi bi-box-arrow-in-right me-2 fs-5"></i>ÄÄ‚NG XUáº¤T
            </a>
          `;

          // ThÃªm má»¥c yÃªu thÃ­ch vÃ o menu
          navbarMenu.querySelector('ul.navbar-nav').innerHTML = `
            <li class="nav-item"><a class="nav-link" href="TrangChu.html">TRANG CHá»¦</a></li>
            <li class="nav-item"><a class="nav-link" href="diaDanh.html">Äá»ŠA DANH Ná»”I Báº¬T</a></li>
            <li class="nav-item"><a class="nav-link" href="Food.html">áº¨M THá»°C</a></li>
            <li class="nav-item"><a class="nav-link" href="nghiDuong.html">NGHá»ˆ DÆ¯á» NG</a></li>
            <li class="nav-item"><a class="nav-link" href="tour.html">TOUR</a></li>
            <li class="nav-item"><a class="nav-link" href="YT.html">Má»¤C YÃŠU THÃCH</a></li>
            <li class="nav-item"><a class="nav-link" href="Lichsu.html">Lá»ŠCH Sá»¬ Äáº¶T TOUR</a></li>
          `;
        }


        loadFavorites();
      });
      

  });
</script>


</body>

</html>